Redis Sentinel lÃ  cÃ¡i gÃ¬?
Má»Ÿ Ä‘áº§u
HÃ´m nay mÃ¬nh muá»‘n giá»›i thiá»‡u Ä‘áº¿n cÃ¡c báº¡n má»™t á»©ng dá»¥ng khÃ¡ lÃ  hay, thÆ°á»ng Ä‘Æ°á»£c cÃ i Ä‘áº·t cÃ¹ng vá»›i cá»¥m Redis Replicaiton Ä‘á»ƒ bá»• sung kháº£ nÄƒng Fail-over hay tÄƒng kháº£ nÄƒng High Availability cho Redis. Náº¿u cÃ¡c báº¡n Ä‘Ã£ tá»«ng thá»­ setup 1 cá»¥m Redis Replication tiÃªu chuáº©n vá»›i 1 node Master vá»›i chá»©c nÄƒng Ä‘á»c ghi vÃ  2 node Slave Ä‘á»ƒ backup dá»¯ liá»‡u thÃ¬ cháº¯c cÃ¡c báº¡n sáº½ khÃ´ng cÃ²n láº¡ gÃ¬ vá»›i tá»« Sentinel. Sentinel Ä‘Æ°á»£c cÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh vÃ´ cÃ¹ng dá»… dÃ ng, cÃ¹ng vá»›i Ä‘Ã³ lÃ  cÃ¡ch hoáº¡t Ä‘á»™ng ráº¥t dá»… hiá»ƒu. ChÃºng ta cÅ©ng báº¯t Ä‘áº§u tÃ¬m hiá»ƒu nhÃ©.
image.png

Redis Sentinel lÃ  cÃ¡i gÃ¬?
Redis Sentinel dÃ¹ng Ä‘á»ƒ giÃ¡m sÃ¡t cÃ¡c node trong cá»¥m Redis, vÃ­ dá»¥ nhÆ° hÃ¬nh trÃªn, cÃ¡c node cÃ³ service redis-sentinel sáº½ giÃ¡m sÃ¡t cÃ¡c node Master vÃ  Slave trong cá»¥m Replication, sau Ä‘Ã³ sáº½ ghi láº¡i log cÃ¡c hoáº¡t Ä‘á»™ng nhÆ° restart, stop, start cá»§a service redis-server.

Nghe cÃ³ váº» hay Ä‘áº¥y, váº­y ghi láº¡i Ä‘á»ƒ lÃ m gÃ¬? Viá»‡c ghi láº¡i log nÃ y sáº½ phá»¥c vá»¥ cho viá»‡c Fail-over (Chuyá»ƒn Ä‘á»•i dá»± phÃ²ng). Náº¿u nhÆ° trÆ°á»›c Ä‘Ã¢y báº¡n chá»‰ cÃ i Ä‘áº·t lÃªn cá»¥m replication thÃ¬ khi node Master cÃ³ váº¥n Ä‘á» (down) thÃ¬ báº¡n sáº½ pháº£i login vÃ o server, kháº¯c phá»¥c thá»§ cÃ´ng báº±ng tay báº±ng cÃ¡ch nÃ¢ng 1 con slave báº¥t ká»³ lÃªn lÃ m Master . Tuy nhiÃªn khi sá»­ dá»¥ng Sentinel thÃ¬ service nÃ y sáº½ giÃºp báº¡n tá»± Ä‘á»™ng hÃ³a viá»‡c nÃ y.

Sau 1 khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh khi Sentinel khÃ´ng thá»ƒ káº¿t ná»‘i vá»›i Master node báº±ng cÃ¡ch gá»­i command PING Ä‘i mÃ  khÃ´ng nháº­n Ä‘Æ°á»£c vá» PONG thÃ¬ sáº½ Ä‘Ã¡nh dáº¥u Node nÃ y Ä‘Ã£ bá»‹ down. Tiáº¿p theo Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh chÃ­nh xÃ¡c, node nÃ y sáº½ há»i cÃ¡c node Sentinel khÃ¡c ráº±ng "Ãª mÃ y cÃ³ tháº¥y tháº±ng Master nÃ y down khÃ´ng?" . Náº¿u 1 sá»‘ node nháº¥t Ä‘á»‹nh cÃ¹ng Ä‘á»“ng Ã½ ráº±ng tháº±ng Master nÃ y down (sá»‘ node cáº§n Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh báº±ng thÃ´ng sá»‘ quorum trong config vá»›i cÃ´ng thá»©c sá»‘ node sentinel/2 + 1 tÆ°Æ¡ng Ä‘Æ°Æ¡ng hÆ¡n 1 ná»­a) thÃ¬ cÃ¡c node Sentinel sáº½ cÃ¹ng nhau báº§u ra 1 Master má»›i. CÃ²n náº¿u sá»‘ node khÃ´ng Ä‘á»§ nhÆ° yÃªu cáº§u thÃ¬ quÃ¡ trÃ¬nh báº§u ra Master má»›i sáº½ bá»‹ hoÃ£n.

Oke giá» chÃºng ta sáº½ cÃ¹ng tÃ¬m ra 1 node Slave phÃ¹ há»£p Ä‘á»ƒ biáº¿n nÃ³ thÃ nh Master. Váº­y trong cÃ¡c node Slave cÃ²n láº¡i, node nÃ o sáº½ Ä‘Æ°á»£c chá»n lÃ m Master? Dá»±a trÃªn cÃ¡c tiÃªu chÃ­ nÃ o? KhÃ¡ Ä‘Æ¡n giáº£n, viá»‡c chá»n ra master tiáº¿p theo dá»±a trÃªn thÃ´ng sá»‘ slave-priority Ä‘Æ°á»£c cáº¥u hÃ¬nh trong file config /etc/redis/redis.conf, náº¿u thÃ´ng sá»‘ khÃ´ng Ä‘Æ°á»£c cáº¥u hÃ¬nh thÃ¬ Sentinel sáº½ tá»± gen ra ID báº¥t ká»³ vÃ  node nÃ o cÃ³ ID tháº¥p hÆ¡n sáº½ Ä‘Æ°á»£c chá»n lÃ m Master.

CÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh
CÃ i Ä‘áº·t
apt install redis-sentinel -y (Ubuntu vÃ  Debian)
yum install redis-sentinel -y (CentOS)

Cáº¥u hÃ¬nh
Cáº¥u hÃ¬nh Sentinel thÃ¬ cÅ©ng khÃ¡ Ä‘Æ¡n giáº£n, dÆ°á»›i Ä‘Ã¢y lÃ  cáº¥u hÃ¬nh máº«u cá»§a mÃ¬nh:

daemonize yes
pidfile "/var/run/redis/redis-sentinel.pid"
logfile "/var/log/redis/redis-sentinel.log"
bind 0.0.0.0
port 26379
dir "/var/lib/redis"
sentinel monitor mymaster 10.5.9.198 6379 2
sentinel down-after-milliseconds mymaster 3000
sentinel failover-timeout mymaster 10000
sentinel auth-pass mymaster password
maxclients 4064
sentinel current-epoch 1

Giáº£i thÃ­ch cÃ¡c thÃ´ng sá»‘ chÃ­nh:

bind: Äá»‹a chá»‰ mÃ  báº¡n muá»‘n Sentinel láº¯ng nghe (á»Ÿ Ä‘Ã¢y 0.0.0.0 tá»©c lÃ  báº¡n cÃ³ thá»ƒ truy cáº­p tá»« má»i IP)
port: port mÃ  Sentinel hoáº¡t Ä‘á»™ng
sentinel monitor: Khai bÃ¡o Ä‘á»‹a chá»‰ node master cáº§n giÃ¡m sÃ¡t (cÃ¡c thÃ´ng sá»‘ láº§n lÆ°á»£t lÃ  <tÃªn cá»¥m> <Master_IP> <Master_Port> < quorum>)
sentinel down-after-milliseconds: Khai bÃ¡o thá»i gian mÃ  Sentinel sáº½ xÃ¡c Ä‘á»‹nh node Master Ä‘Ã£ down (á»Ÿ Ä‘Ã¢y sau khi 3s khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c Master thÃ¬ Sentinel sáº½ cho ráº±ng node nÃ y Ä‘Ã£ down).
sentinel failover-timeout: Thá»i gian sáº½ há»§y quÃ¡ trÃ¬nh fail-over náº¿u chÆ°a thÃ nh cÃ´ng.
sentinel auth-pass: Náº¿u Node Master báº¡n cÃ³ password thÃ¬ thÃªm config nÃ y Ä‘á»ƒ cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c, khÃ´ng cÃ³ pass thÃ¬ bá» dÃ²ng nÃ y.
Thá»­ nghiá»‡m
Sau khi Ä‘Ã£ cáº¥u hÃ¬nh xong, Sentinel sáº½ káº¿t ná»‘i Ä‘áº¿n Master Node láº¥y cÃ¡c thÃ´ng tin vá» Slave Node vÃ  Sentinel Node Ä‘á»ƒ giÃ¡m sÃ¡t. CÃ¹ng vá»›i Ä‘Ã³ cÃ¡c node Sentinel cÅ©ng sáº½ giÃ¡m sÃ¡t chÃ©o nhau.

Thá»­ stop node Master, trÃªn cÃ¡c node Sentinel sá»­ dá»¥ng cÃ¢u lá»‡nh tail -f /var/log/redis/redis-sentinel.log Ä‘á»ƒ xem quÃ¡ trÃ¬nh fail-over.
image.png

Äáº§u tiÃªn Sentinel xÃ¡c Ä‘á»‹nh node master Ä‘Ã£ down nÃªn khá»Ÿi táº¡o vote-for-leader
XÃ¡c Ä‘á»‹nh sá»‘ node sentinel cáº§n thiáº¿t Ä‘á»ƒ vote master 3 > 2 (thá»a mÃ£n)
Cáº­p nháº­t láº¡i cáº¥u hÃ¬nh, tiáº¿n hÃ nh thay Ä‘á»•i Master switch-master sang node 10.5.9.126
Cáº­p nháº­t cÃ¡c Slave má»›i cho node Master vÃ  Master cho cÃ¡c node Slave. Káº¿t thÃºc quÃ¡ trÃ¬nh fail-over.
NgoÃ i ra, redis sentinel cÃ²n cÃ³ kháº£ nÄƒng giÃ¡m sÃ¡t nhiá»u master cÃ¹ng lÃºc báº±ng cÃ¡ch sá»­ dá»¥ng command sentinel monitor <name> <MASTER_IP> <MASTER_PORT> <quorum>

Káº¿t
Sentinel lÃ  má»™t cá»™ng cá»¥ giÃºp Ä‘Æ¡n giáº£n mÃ  vÃ´ cÃ¹ng hiá»‡u quáº£ trong viá»‡c thá»±c hiá»‡n Fail-over, báº±ng cÃ¡ch káº¿t há»£p thÃªm HAProxy + KeepAlived mÃ  mÃ¬nh hÆ°á»›ng dáº«n á»Ÿ bÃ i trÆ°á»›c thÃ¬ báº¡n cÃ³ thá»ƒ táº¡o ra 1 cá»¥m Redis cÃ³ Ä‘á»™ bá»n, kháº£ nÄƒng chá»‹u lá»—i cao.

ChÃºc cÃ¡c báº¡n thá»­ nghiá»‡m thÃ nh cÃ´ng! ğŸ˜„