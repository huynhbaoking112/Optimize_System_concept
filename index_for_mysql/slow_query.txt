Trong má»™t ngÃ y Ä‘áº¹p trá»i, dá»± Ã¡n khÃ¡ch hÃ ng sau khi náº±m im máº¥y thÃ¡ng trá»i thÃ¬ cuá»‘i cÃ¹ng cÅ©ng Ä‘Æ°á»£c deploy lÃªn production. Sau khi deploy thÃ nh cÃ´ng, gáº·p pháº£i má»™t issue khÃ¡ nghiÃªm trá»ng Ä‘Ã³ lÃ  trang chá»§ trÃªn production load dá»¯ liá»‡u ráº¥t lÃ¢u, máº¥t khoáº£ng 20s. Tháº¿ lÃ  mÃ¬nh Ä‘Æ°á»£c giao ngay task tÃ¬m ra nguyÃªn nhÃ¢n gÃ¢y ra issue Ä‘Ã³ vÃ  cÃ¡ch giáº£i quyáº¿t ra lÃ m sao. Khi Ä‘Ã³ mÃ¬nh nghÄ© ngay Ä‘áº¿n Ä‘Ã¡nh index cho DB. Váº­y lÃ m tháº¿ nÃ o Ä‘á»ƒ Ä‘Ã¡nh index há»£p lÃ­ ? LÃ m sao Ä‘á»ƒ biáº¿t cÃ¢u query Ä‘Ã³ Ä‘Ã£ Ä‘Æ°á»£c optimize chÆ°a ? NÃ o cÃ¹ng mÃ¬nh tÃ¬m hiá»ƒu cÃ¡ch giáº£i quyáº¿t bÃ i toÃ¡n slow query.

Back to Basic
Gá»£i nhá»› láº¡i kiáº¿n thá»©c má»™t chÃºt. Váº­y Index lÃ  gÃ¬? VÃ  táº¡i sao nÃ³ láº¡i quan trá»ng trong viá»‡c giáº£i quyáº¿t bÃ i toÃ¡n slow query.

Chá»‰ má»¥c (Index) lÃ  báº£ng tra cá»©u Ä‘áº·c biá»‡t mÃ  Database Search Engine cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘á»ƒ tÄƒng nhanh thá»i gian vÃ  hiá»‡u suáº¥t thu tháº­p dá»¯ liá»‡u. Hiá»ƒu Ä‘Æ¡n giáº£n, má»™t chá»‰ má»¥c lÃ  má»™t con trá» tá»›i dá»¯ liá»‡u trong má»™t báº£ng. Má»™t chá»‰ má»¥c trong má»™t Database lÃ  tÆ°Æ¡ng tá»± nhÆ° má»™t chá»‰ má»¥c trong Má»¥c lá»¥c cá»§a cuá»‘n sÃ¡ch.

Chá»‰ má»¥c (Index) Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ tÃ¬m ra nhá»¯ng báº£n ghi (record) thá»a mÃ£n Ä‘iá»u kiá»‡n trong má»‡nh Ä‘á» WHERE. Náº¿u khÃ´ng cÃ³ chá»‰ má»¥c (index), MySQL sáº½ pháº£i Ä‘á»c toÃ n bá»™ báº£n ghi (record) tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i cá»§a báº£ng (table) vÃ  tÃ¬m ra nhá»¯ng báº£n ghi (record) thá»a mÃ£n Ä‘iá»u kiá»‡n trong má»‡nh Ä‘á» WHERE. Khi record trong table cÃ ng tÄƒng, thÃ¬ cÃ ng máº¥t thá»i gian Ä‘á»ƒ thá»±c hiá»‡n cÃ¢u query. Trong trÆ°á»ng há»£p cÃ²n láº¡i, náº¿u tá»“n táº¡i index, MySQL cÃ³ thá»ƒ nhanh chÃ³ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c vá»‹ trÃ­ record cáº§n tÃ¬m trong table thay vÃ¬ pháº£i Ä‘á»c record tuáº§n tá»± tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i. Má»i ngÆ°á»i cÃ³ thá»ƒ Ä‘á»c thÃªm vá» index táº¡i Ä‘Ã¢y: https://link.sun-asterisk.vn/4YKIH4

VÃ¬ váº­y Ä‘á»ƒ giáº£i quyáº¿t bÃ i toÃ¡n slow query, sá»­ dá»¥ng index lÃ  Æ°u tiÃªn hÃ ng Ä‘Ã¢u.

Study case
á» Ä‘áº¥y, mÃ¬nh cÃ³ chuáº©n bá»‹ má»™t DB gá»“m cÃ³ 2 báº£ng lÃ  service vÃ  service_event. á» báº£ng service cÃ³ 42 record, vÃ  báº£ng service_event cÃ³ 781479 record. Má»i ngÆ°á»i cÃ³ thá»ƒ download DB máº«u táº¡i Ä‘Ã¢y: https://link.sun-asterisk.vn/eVl8Hm. Khi download xong, má»i ngÆ°á»i import vÃ o lÃ  cÃ³ thá»ƒ sá»­ dá»¥ng luÃ´n.


Trong DB trÃªn, á»Ÿ 2 báº£ng service vÃ  service_event cÃ³ cá»™t ID lÃ  primary key vÃ  Ä‘Ã¢y lÃ  index máº·c Ä‘á»‹nh cho 2 báº£ng nÃ y. NgoÃ i ra trong báº£ng service_event, cÃ²n cÃ³ foreign key lÃ  service_id, cÅ©ng lÃ  index cho báº£ng nÃ y. Trong quÃ¡ trÃ¬nh táº¡o khÃ³a ngoáº¡i, MySQL sáº½ khÃ´ng tá»± táº¡o index cho khÃ³a ngoáº¡i. VÃ¬ váº­y, náº¿u foreign key trong cÃ¡c báº£ng khÃ´ng Ä‘Æ°á»£c Ä‘Ã¡nh index thÃ¬ má»i ngÆ°á»i nÃªn Ä‘Ã¡nh index cho trÆ°á»ng nÃ y.
Explain query to optimize
MÃ¬nh cÃ³ cÃ¢u query sau:
SELECT service_id, COUNT(*)
  FROM service_event
  WHERE status = 'error' AND created_at >= DATE(NOW()) - INTERVAL 2 YEAR GROUP BY service_id;

Thá»i gian cháº¡y vÃ  tá»•ng sá»‘ record tráº£ vá» cÃ¢u query trÃªn lÃ :


Äá»ƒ phÃ¢n tÃ­ch rÃµ hÆ¡n xem cÃ¢u query trÃªn hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o, mÃ¬nh sáº½ sá»­ dá»¥ng EXPLAIN
EXPLAIN SELECT service_id, COUNT(*)
          FROM service_event
          WHERE status = 'error' AND created_at >= DATE(NOW()) - INTERVAL 2 YEAR GROUP BY service_id;

Káº¿t quáº£ nháº­n Ä‘Æ°á»£c nhÆ° sau:


NhÃ¬n vÃ o káº¿t quáº£ trÃªn, má»i ngÆ°á»i cáº§n chÃº Ã½ vÃ o cÃ¡c trÆ°á»ng sau:

type: MÃ´ táº£ cÃ¡ch cÃ¡c báº£ng Ä‘Æ°á»£c join trong cÃ¢u truy váº¥n. Má»i ngÆ°á»i cÃ³ thá»ƒ Ä‘á»c thÃªm vá» type táº¡i Ä‘Ã¢y: https://dev.mysql.com/doc/refman/8.0/en/explain-output.html#explain-join-types. á» trong trÆ°á»ng há»£p nÃ y, type cá»§a query Ä‘áº§u tiÃªn lÃ  index, cÃ³ nghÄ©a lÃ  á»Ÿ cÃ¢u truy váº¥n nÃ y cÃ³ sá»­ dá»¥ng index Ä‘á»ƒ tÃ¬m ra nhá»¯ng báº£n ghi thoáº£ mÃ£n Ä‘iá»u kiá»‡n trong báº£ng service_event.
possible_keys: CÃ¡c index cÃ³ thá»ƒ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ tÃ¬m ra nhá»¯ng báº£n ghi thoáº£ mÃ£n Ä‘iá»u kiá»‡n. á» trong trÆ°á»ng há»£p nÃ y, index cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng lÃ service_events_service_id_fk.
key: Index Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ tÃ¬m ra nhá»¯ng báº£n ghi thá»a mÃ£n Ä‘iá»u kiá»‡n. Trong trÆ°á»ng há»£p nÃ y, thÃ¬ index Ä‘Æ°á»£c sá»­ dá»¥ng lÃ  service_events_service_id_fk.
rows: Sá»‘ báº£n ghi mÃ  MySQL Ä‘Ã£ Ä‘á»c Ä‘á»ƒ tÃ¬m ra nhá»¯ng báº£n ghi thá»a mÃ£n. Trong trÆ°á»ng há»£p nÃ y, sá»‘ báº£n ghi MySQL Ä‘Ã£ Ä‘á»c lÃ  77896 báº£n ghi.
CÃ³ thá»ƒ tháº¥y ráº±ng, khi sá»­ dá»¥ng index service_events_service_id_fk, sá»‘ lÆ°á»£ng báº£n ghi cáº§n Ä‘á»c Ä‘á»ƒ tÃ¬m ra sá»‘ báº£n ghi thá»a mÃ£n Ä‘iá»u kiá»‡n váº«n cÃ²n quÃ¡ nhiá»u, bá»Ÿi vÃ¬ output cá»§a query trÃªn lÃ  31 báº£n ghi. Cáº§n pháº£i Ä‘á»c 777896 báº£n ghi má»›i cÃ³ thá»ƒ tÃ¬m ra 31 báº£n ghi thá»a mÃ£n. CÃ³ nghÄ©a lÃ  Ä‘Ã¡nh index nhÆ° nÃ y chÆ°a pháº£i lÃ  tá»‘i Æ°u. Váº­y Ä‘Ã¡nh index nhÆ° tháº¿ nÃ o má»›i lÃ  tá»‘i Æ°u?

ThÃ´ng thÆ°á»ng, chÃºng ta thÆ°á»ng Ä‘Ã¡nh index cho nhá»¯ng trÆ°á»ng mÃ  sá»­ dá»¥ng trÆ°á»ng Ä‘Ã³ Ä‘á»ƒ search dá»¯ liá»‡u (name, mail, ...). Nhá»¯ng index tá»‘i Æ°u lÃ  nhá»¯ng index Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ phá»¥c vá»¥ cho viá»‡c cháº¡y query. DÄ© nhiÃªn, khi mÃ  khá»Ÿi táº¡o cÃ¡c báº£ng, chÃºng ta khÃ´ng thá»ƒ biáº¿t sáº½ pháº£i viáº¿t nhá»¯ng query nÃ o, vÃ  nÃªn Ä‘Ã¡nh index vÃ o trÆ°á»ng nÃ o. KhÃ´ng nÃªn Ä‘Ã¡nh index cho toÃ n cÃ¡c trÆ°á»ng trong báº£ng, bá»Ÿi vÃ¬ khi lÃ m nhÆ° váº­y sáº½ dáº«n tá»›i áº£nh hÆ°á»Ÿng performance nhá»¯ng cÃ¢u query insert/update/delete. Khi insert/update/delete thÃ¬ sáº½ pháº£i Ä‘Ã¡nh index láº¡i tá»« Ä‘áº§u dáº«n tá»›i performance cá»§a nhá»¯ng cÃ¢u query Ä‘Ã³ sáº½ bá»‹ cháº­m. VÃ¬ váº­y, chá»‰ Ä‘Ã¡nh index cho cÃ¡c trÆ°á»ng phá»¥c vá»¥ viá»‡c cháº¡y query, khÃ´ng nÃªn gÃ¢y dÆ° thá»«a index.

Quay láº¡i cÃ¢u query trÃªn, váº­y sáº½ pháº£i Ä‘Ã¡nh index cho nhá»¯ng trÆ°á»ng nÃ o trong báº£ng? Trong má»‡nh Ä‘á» WHERE cÃ¢u query trÃªn, cÃ³ sá»­ dá»¥ng 2 trÆ°á»ng lÃ  status vÃ  created_at. Thá»­ Ä‘Ã¡nh index cho 2 trÆ°á»ng nÃ y xem sao?

create index idx_status on service_event(status);
create index idx_created_at on service_event(created_at);

Sau khi Ä‘Ã¡nh index, cháº¡y thá»­ cÃ¢u query, káº¿t quáº£ tráº£ vá» nhÆ° sau:


Váº­y lÃ  performance cá»§a cÃ¢u query Ä‘Ã£ cáº£i thiá»‡n Ä‘Ã¡ng ká»ƒ, tá»« 1.38 giÃ¢y cÃ²n 0.09 giÃ¢y. MÃ¬nh thá»­ EXPLAIN cÃ¢u query, xem sá»‘ lÆ°á»£ng báº£n ghi MySQL Ä‘Ã£ Ä‘á»c Ä‘á»ƒ tÃ¬m ra sá»‘ báº£n ghi thá»a mÃ£n Ä‘iá»u kiá»‡n trong má»‡nh Ä‘á» where lÃ  bao nhiÃªu:
EXPLAIN SELECT service_id, COUNT(*)
          FROM service_event
          WHERE status = 'error' AND created_at >= DATE(NOW()) - INTERVAL 2 YEAR GROUP BY service_id \G;



CÃ³ thá»ƒ tháº¥y, trÆ°á»ng possible_key Ä‘Ã£ cÃ³ thÃªm nhá»¯ng index mÃ¬nh vá»«a má»›i táº¡o Ä‘Ã³ lÃ : idx_status vÃ  idx_created_at, trÆ°á»ng key Ä‘Ã£ cÃ³ sá»± thay Ä‘á»•i Ä‘Ã³ lÃ  sá»­ dá»¥ng index idx_status thay vÃ¬ sá»­ dá»¥ng index service_events_service_id_fk. VÃ  sá»‘ lÆ°á»£ng record mÃ  MySQL Ä‘Ã£ Ä‘á»c giáº£m tá»« 777896 xuá»‘ng 83474, má»™t con sá»‘ khÃ¡ áº¥n tÆ°á»£ng. NhÆ°ng váº«n cÃ²n cÃ³ khÃ¡ nhiá»u so vá»›i output cá»§a cÃ¢u query lÃ  31 record. Váº­y táº¡i sao láº¡i nhÆ° váº­y ?
Sá»± tháº­t, khÃ´ng pháº£i táº¥t cáº£ cÃ¡c trÆ°á»ng trong má»‡nh Ä‘á» WHERE Ä‘Æ°á»£c Ä‘Ã¡nh index thÃ¬ cÃ³ nghÄ©a lÃ  cÃ¢u query Ä‘Ã³ sáº½ Ä‘áº¡t performance tá»‘t nháº¥t. Trong trÆ°á»ng há»£p nÃ y, MySQL sáº½ xem cÃ¡c index trong trÆ°á»ng possible_keys vÃ  tá»± chá»n ra index phÃ¹ há»£p cho cÃ¢u query Ä‘Ã³ lÃ  idx_status. Äiá»u Ä‘Ã³ cÃ³ nghÄ©a ráº±ng lÃ , MySQL sáº½ tÃ¬m nhá»¯ng báº£n ghi thá»a mÃ£n Ä‘iá»u kiá»‡n status = 'error' theo index idx_status, tá»« nhá»¯ng báº£n ghi Ä‘Ã³ sáº½ lá»c ra nhá»¯ng báº£n ghi thá»a mÃ£n Ä‘iá»u kiá»‡n created_at >= DATE(NOW()) - INTERVAL 2 YEAR GROUP BY service_id. VÃ¬ váº­y 83474 lÃ  sá»‘ báº£n ghi thoáº£ mÃ£n Ä‘iá»u kiá»‡n status = 'error', MySQL pháº£i Ä‘á»c háº¿t sá»‘ báº£n ghi nÃ y Ä‘á»ƒ tÃ¬m ra nhá»¯ng báº£n ghi thoáº£ mÃ£n Ä‘iá»u kiá»‡n cÃ²n láº¡i. Váº­y cÃ³ thá»ƒ lÃ m giáº£m sá»‘ lÆ°á»£ng báº£n ghi nÃ y xuá»‘ng ná»¯a khÃ´ng ? MÃ¬nh nghÄ© tá»›i Multiple-Column Indexes.
Multiple-Column Indexes: MySQL cÃ³ thá»ƒ táº¡o 1 index cho nhiá»u trÆ°á»ng trong báº£ng. Má»™t index cÃ³ thá»ƒ bao gá»“m tá»‘i Ä‘a 16 trÆ°á»ng. MySQL cÃ³ thá»ƒ dÃ¹ng multiple-column indexes cho cÃ¡c cÃ¢u truy váº¥n mÃ  cÃ¡c trÆ°á»ng trong multiple-column indexes xuáº¥t hiá»‡n trong má»‡nh Ä‘á» where cá»§a cÃ¢u truy váº¥n Ä‘Ã³. Trong trÆ°á»ng há»£p trÃªn, á»Ÿ má»‡nh Ä‘á» where cÃ³ 2 trÆ°á»ng lÃ  status vÃ  created_at. MÃ¬nh sáº½ Ä‘Ã¡nh multiple-column indexes cho 2 trÆ°á»ng nÃ y:
 create index idx_status_created_at on service_event(status, created_at);

Explain cÃ¢u query Ä‘á»ƒ xem cÃ³ sá»± thay Ä‘á»•i nÃ o khÃ´ng ?




CÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c ráº±ng index Ä‘Æ°á»£c sá»­ cho cÃ¢u query nÃ y váº«n lÃ  idx_status vÃ  tá»‘c Ä‘á»™ cÃ¢u truy váº¥n váº«n khÃ´ng thay Ä‘á»•i. RÃµ rÃ ng mÃ¬nh Ä‘Ã£ Ä‘Ã¡nh thÃªm index cho cáº£ 2 trÆ°á»ng lÃ  status vÃ  created_at. Váº­y táº¡i sao MySQL láº¡i khÃ´ng sá»­ dá»¥ng index nÃ y ?
Máº·c Ä‘á»‹nh MySQL sáº½ sá»­ dá»¥ng index mÃ  nÃ³ cho ráº±ng cÃ³ tá»‘c Ä‘á»™ truy váº¥n tá»‘t nháº¥t. NÃ³ sáº½ khÃ´ng biáº¿t nhá»¯ng index cÃ³ cho tá»‘c Ä‘á»™ tá»‘t hÆ¡n ná»¯a khÃ´ng. á» trong case nÃ y, mÃ¬nh nghÄ© multiple-column index sáº½ cho tá»‘c Ä‘á»™ truy váº¥n tá»‘t hÆ¡n. VÃ¬ váº­y Ä‘á»ƒ chá»‰ Ä‘á»‹nh MySQL sáº½ sá»­ dá»¥ng index nÃ o cho cÃ¢u truy váº¥n, mÃ¬nh sáº½ sá»­ dá»¥ng FORCE INDEX (index_name). Cá»¥ thá»ƒ mÃ¬nh sáº½ cÃ³ cÃ¢u truy váº¥n nhÆ° sau:
SELECT
    service_id, COUNT(*)
FROM
    service_event FORCE INDEX (idx_status_created_at)
WHERE
    status = 'error' AND created_at >= DATE(NOW()) - INTERVAL 2 YEAR
GROUP BY
    service_id;

Káº¿t quáº£ lÃ :


CÃ³ thá»ƒ tháº¥y ráº±ng, káº¿t quáº£ Ä‘Ã£ cáº£i thiá»‡n hÆ¡n. MÃ¬nh sáº½ explain xem sá»‘ lÆ°á»£ng báº£n ghi mÃ  MySQL pháº£i Ä‘á»c Ä‘á»ƒ tÃ¬m ra sá»‘ báº£n ghi thá»a mÃ£n Ä‘iá»u kiá»‡n trong má»‡nh Ä‘á» where lÃ  bao nhiÃªu:


Sá»‘ lÆ°á»£ng báº£n ghi MySQL pháº£i Ä‘á»c lÃ  36252, Ä‘Ã£ giáº£m Ä‘Ã¡ng ká»ƒ. Váº­y lÃ  cÃ¢u truy váº¥n nÃ y Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u nháº¥t. ğŸ’¯
Conclusion
NÃªn Ä‘Ã¡nh index cho foreign key trong cÃ¡c báº£ng.
KhÃ´ng nÃªn Ä‘Ã¡nh index cho táº¥t cáº£ cÃ¡c trÆ°á»ng trong báº£ng. Chá»‰ nÃªn Ä‘Ã¡nh index cho cÃ¡c trÆ°á»ng phá»¥c vá»¥ cho viá»‡c truy váº¥n. Nhá»¯ng trÆ°á»ng trong má»‡nh Ä‘á» WHERE thÃ¬ nÃªn Ä‘Ã¡nh index.
Khi cáº£m tháº¥y index nÃ o cÃ³ hiá»‡u quáº£ mÃ  MySQL khÃ´ng sá»­ dá»¥ng Ä‘áº¿n nÃ³ hÃ£y sá»­ dá»¥ng FORCE INDEX Ä‘á»ƒ chá»‰ Ä‘á»‹nh index cho cÃ¢u truy váº¥n.
Náº¿u Ä‘Ã¡nh index rá»“i mÃ  performance cÃ¢u truy váº¥n khÃ´ng thá»ƒ cáº£i thiá»‡n thÃ¬ hÃ£y viáº¿t má»™t cÃ¢u truy váº¥n má»›i. ğŸ˜…